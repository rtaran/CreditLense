<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data - Credit Lense</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', path='/favicon.ico') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>Credit Lense</h1>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/documents">Documents</a></li>
                    <li><a href="/memos">Memos</a></li>
                    <li><a href="/upload">Upload</a></li>
                    <li><a href="/methodology">Methodology</a></li>
                    <li><a href="/memo-format">Memo Format</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <h2>Financial Data for {{ document.company_name or "Unknown Company" }}</h2>
        <p>Document: {{ document.pdf_file_name }}</p>

        {% if not financial_data.years %}
            <div class="empty-state">
                <p>No financial data has been extracted for this document yet. This may take a few moments after upload.</p>
                <p><a href="/documents">Return to Documents</a></p>
            </div>
        {% else %}
            <div class="financial-data-container">
                <div class="years-selector">
                    <h3>Select Year:</h3>
                    <div class="year-tabs">
                        {% for year in financial_data.years %}
                            <button class="year-tab {% if year == selected_year %}active{% endif %}" 
                                    onclick="showYear('{{ year }}')">{{ year }}</button>
                        {% endfor %}
                    </div>
                </div>

                {% for year in financial_data.years %}
                    <div id="year-{{ year }}" class="year-data {% if year != selected_year %}hidden{% endif %}">
                        <h3>Financial Data for {{ year }}</h3>

                        <!-- Balance Sheet -->
                        {% if year in financial_data.balance_sheet %}
                            <div class="data-section">
                                <h4>Balance Sheet</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Item</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category, items in financial_data.balance_sheet[year].items() %}
                                            {% for item_name, item_value in items.items() %}
                                                {% if item_value is not none %}
                                                    <tr>
                                                        <td>{{ category }}</td>
                                                        <td>{{ item_name }}</td>
                                                        <td class="numeric">{{ "{:,.2f}".format(item_value) }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}

                        <!-- Income Statement -->
                        {% if year in financial_data.income_statement %}
                            <div class="data-section">
                                <h4>Income Statement</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Item</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category, items in financial_data.income_statement[year].items() %}
                                            {% for item_name, item_value in items.items() %}
                                                {% if item_value is not none %}
                                                    <tr>
                                                        <td>{{ category }}</td>
                                                        <td>{{ item_name }}</td>
                                                        <td class="numeric">{{ "{:,.2f}".format(item_value) }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}

                        <!-- Cash Flow -->
                        {% if year in financial_data.cash_flow %}
                            <div class="data-section">
                                <h4>Cash Flow</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Item</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category, items in financial_data.cash_flow[year].items() %}
                                            {% for item_name, item_value in items.items() %}
                                                {% if item_value is not none %}
                                                    <tr>
                                                        <td>{{ category }}</td>
                                                        <td>{{ item_name }}</td>
                                                        <td class="numeric">{{ "{:,.2f}".format(item_value) }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}

                        <!-- Financial Ratios -->
                        {% if year in financial_data.ratios %}
                            <div class="data-section">
                                <h4>Financial Ratios</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Ratio</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category, items in financial_data.ratios[year].items() %}
                                            {% for ratio_name, ratio_value in items.items() %}
                                                {% if ratio_value is not none %}
                                                    <tr>
                                                        <td>{{ category }}</td>
                                                        <td>{{ ratio_name }}</td>
                                                        <td class="numeric">{{ "{:.2f}".format(ratio_value) }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Extraction Process Details -->
            <div class="extraction-details">
                <h3>Extraction Process Details</h3>
                <div class="extraction-toggle">
                    <button id="toggle-extraction-details" class="btn secondary">Show Extraction Details</button>
                </div>
                <div id="extraction-details-content" class="hidden">
                    <div class="data-section">
                        <h4>Document Information</h4>
                        <p><strong>Document ID:</strong> {{ document.document_id }}</p>
                        <p><strong>File Name:</strong> {{ document.pdf_file_name }}</p>
                        <p><strong>Company Name:</strong> {{ document.company_name or "Unknown" }}</p>
                        <p><strong>PDF Text Length:</strong> {{ document.pdf_string|length }} characters</p>
                    </div>

                    <div class="data-section">
                        <h4>Extraction Summary</h4>
                        <p><strong>Years Extracted:</strong> {{ financial_data.years|join(", ") }}</p>
                        <p><strong>Balance Sheet Items:</strong> 
                            {% set bs_count = 0 %}
                            {% for year in financial_data.years %}
                                {% for category in financial_data.balance_sheet.get(year, {}) %}
                                    {% set bs_count = bs_count + financial_data.balance_sheet.get(year, {}).get(category, {})|length %}
                                {% endfor %}
                            {% endfor %}
                            {{ bs_count }}
                        </p>
                        <p><strong>Income Statement Items:</strong> 
                            {% set is_count = 0 %}
                            {% for year in financial_data.years %}
                                {% for category in financial_data.income_statement.get(year, {}) %}
                                    {% set is_count = is_count + financial_data.income_statement.get(year, {}).get(category, {})|length %}
                                {% endfor %}
                            {% endfor %}
                            {{ is_count }}
                        </p>
                        <p><strong>Cash Flow Items:</strong> 
                            {% set cf_count = 0 %}
                            {% for year in financial_data.years %}
                                {% for category in financial_data.cash_flow.get(year, {}) %}
                                    {% set cf_count = cf_count + financial_data.cash_flow.get(year, {}).get(category, {})|length %}
                                {% endfor %}
                            {% endfor %}
                            {{ cf_count }}
                        </p>
                        <p><strong>Financial Ratios:</strong> 
                            {% set ratio_count = 0 %}
                            {% for year in financial_data.years %}
                                {% for category in financial_data.ratios.get(year, {}) %}
                                    {% set ratio_count = ratio_count + financial_data.ratios.get(year, {}).get(category, {})|length %}
                                {% endfor %}
                            {% endfor %}
                            {{ ratio_count }}
                        </p>
                    </div>

                    <div class="data-section">
                        <h4>Raw PDF Text Preview</h4>
                        <div class="pdf-text-preview">
                            {{ document.pdf_string[:500] }}{% if document.pdf_string|length > 500 %}...{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <a href="/documents" class="btn secondary">Back to Documents</a>
                <div class="memo-actions">
                    <select class="llm-provider-select" id="provider-{{ document.document_id }}">
                        <option value="google">Google Gemini</option>
                        <option value="openai">OpenAI GPT</option>
                    </select>
                    <button class="btn primary generate-memo" data-id="{{ document.document_id }}">Generate Memo</button>
                    <button class="btn primary compare-llms" data-id="{{ document.document_id }}">Compare LLMs</button>
                </div>
            </div>
        {% endif %}
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Credit Lense. All rights reserved.</p>
        </div>
    </footer>

    <script>
        function showYear(year) {
            // Hide all year data
            const yearDivs = document.querySelectorAll('.year-data');
            yearDivs.forEach(div => {
                div.classList.add('hidden');
            });

            // Show the selected year data
            const selectedYearDiv = document.getElementById(`year-${year}`);
            if (selectedYearDiv) {
                selectedYearDiv.classList.remove('hidden');
            }

            // Update active tab
            const yearTabs = document.querySelectorAll('.year-tab');
            yearTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            const selectedTab = document.querySelector(`.year-tab[onclick="showYear('${year}')"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
        }

        // Add event listener for the extraction details toggle button
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('toggle-extraction-details');
            const extractionContent = document.getElementById('extraction-details-content');

            if (toggleButton && extractionContent) {
                toggleButton.addEventListener('click', function() {
                    if (extractionContent.classList.contains('hidden')) {
                        extractionContent.classList.remove('hidden');
                        toggleButton.textContent = 'Hide Extraction Details';
                    } else {
                        extractionContent.classList.add('hidden');
                        toggleButton.textContent = 'Show Extraction Details';
                    }
                });
            }
        });
    </script>

    <style>
        .financial-data-container {
            margin-top: 2rem;
        }

        .years-selector {
            margin-bottom: 1.5rem;
        }

        .year-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .year-tab {
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .year-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .year-data {
            margin-bottom: 2rem;
        }

        .hidden {
            display: none;
        }

        .data-section {
            margin-bottom: 2rem;
        }

        .data-section h4 {
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }

        .numeric {
            text-align: right;
            font-family: monospace;
        }

        .actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        /* Extraction Details Styles */
        .extraction-details {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .extraction-details h3 {
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .extraction-toggle {
            margin-bottom: 1rem;
        }

        .pdf-text-preview {
            padding: 1rem;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</body>
</html>
